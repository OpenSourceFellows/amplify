const path = require('path')
const express = require('express')
const history = require('connect-history-api-fallback')
const apiRouter = require('./api')

const app = express()

// Enable if you're behind a reverse proxy (Heroku, Bluemix, AWS ELB or API Gateway, Nginx, etc)
// see https://expressjs.com/en/guide/behind-proxies.html
app.set('trust proxy', true)

const representativeTestMidlleware = (req, res, next) => {
  if (req.url.includes('/representatives') && process.env.NODE_ENV === 'test') {
    // Redirect to the test endpoint
    req.url = '/mock-representatives/94041'
  }
  next()
}

// Load the API router
app.use('/api', representativeTestMidlleware, apiRouter)

// Fix for hash URLs in Vue
// IMPORTANT: MUST be added before the `express.static` middleware for the `dist/` directory
app.use(history())

// Routes generated by Vue CLI
const staticPath = path.resolve(__dirname, '../dist')
app.use(express.static(staticPath, { maxAge: '1d', etag: false }))

module.exports = app
